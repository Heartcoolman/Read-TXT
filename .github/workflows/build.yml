name: Build iOS App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'
      
      - name: Show Xcode version
        run: xcodebuild -version
      
      - name: Build Unsigned Archive
        run: |
          # åˆ›å»ºæ„å»ºç›®å½•
          mkdir -p build
          
          # æ„å»ºæœªç­¾åçš„ Archive
          xcodebuild archive \
            -project TxtReader.xcodeproj \
            -scheme TxtReader \
            -sdk iphoneos \
            -configuration Release \
            -archivePath build/TxtReader.xcarchive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO
          
          echo "âœ… Archive æ„å»ºå®Œæˆ"
          echo "ğŸ“¦ ä½ç½®: build/TxtReader.xcarchive"
      
      - name: Create App Bundle
        run: |
          # ä» xcarchive ä¸­æå– .app
          mkdir -p build/Payload
          cp -R build/TxtReader.xcarchive/Products/Applications/TxtReader.app build/Payload/
          
          # åˆ›å»º IPAï¼ˆæœªç­¾åï¼‰
          cd build
          zip -r TxtReader-unsigned.ipa Payload
          cd ..
          
          echo "âœ… æœªç­¾å IPA åˆ›å»ºå®Œæˆ"
          echo "ğŸ“¦ ä½ç½®: build/TxtReader-unsigned.ipa"
    
      - name: Upload Unsigned IPA
        uses: actions/upload-artifact@v4
        with:
          name: TxtReader-Unsigned-IPA
          path: build/TxtReader-unsigned.ipa
          retention-days: 30
          if-no-files-found: error
      
      - name: Upload xcarchive
        uses: actions/upload-artifact@v4
        with:
          name: TxtReader-xcarchive
          path: build/TxtReader.xcarchive
          retention-days: 30
          if-no-files-found: warn
      
      - name: Build Summary
        run: |
          echo "ğŸ‰ æ„å»ºå®Œæˆï¼"
          echo ""
          echo "ğŸ“¦ å·²ç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š"
          echo "  â€¢ TxtReader-unsigned.ipa - æœªç­¾åçš„ IPAï¼ˆéœ€è¦è‡ªç­¾åï¼‰"
          echo "  â€¢ TxtReader.xcarchive - Xcode Archiveï¼ˆå¯åœ¨ Xcode ä¸­å¯¼å‡ºï¼‰"
          echo ""
          echo "âš¡ ä¸‹ä¸€æ­¥ï¼š"
          echo "  1. ä¸‹è½½ Artifacts"
          echo "  2. ä½¿ç”¨ AltStore/Sideloadly ç­¾åå¹¶å®‰è£…"
          echo "  3. æˆ–ä½¿ç”¨ TrollStore ç›´æ¥å®‰è£…"
          echo ""
          echo "ğŸ“– è¯¦è§ INSTALLATION.md"
    
      - name: Create Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          body: |
            ## TXTé˜…è¯»å™¨ - æœªç­¾åç‰ˆæœ¬
            
            è¿™æ˜¯è‡ªåŠ¨æ„å»ºçš„æœªç­¾å IPA æ–‡ä»¶ã€‚
            
            ### å®‰è£…æ–¹æ³•
            
            1. **ä½¿ç”¨ AltStore**:
               - åœ¨ iPad ä¸Šå®‰è£… AltStore
               - ä¸‹è½½ IPA æ–‡ä»¶
               - é€šè¿‡ AltStore å®‰è£…
            
            2. **ä½¿ç”¨ Sideloadly**:
               - åœ¨ç”µè„‘ä¸Šå®‰è£… Sideloadly
               - è¿æ¥ iPad
               - ä½¿ç”¨ Apple ID ç­¾åå¹¶å®‰è£…
            
            3. **ä½¿ç”¨ TrollStore** (å¦‚æœå·²è¶Šç‹±):
               - ç›´æ¥å®‰è£… IPA æ–‡ä»¶
            
            ### åŠŸèƒ½ç‰¹æ€§
            
            - âœ… WebDAV åœ¨çº¿é˜…è¯»
            - âœ… æ™ºèƒ½ç¼–ç è¯†åˆ«ï¼ˆæ”¯æŒ UTF-8ã€GBKã€Big5 ç­‰ï¼‰
            - âœ… åˆ†é¡µ/æ»šåŠ¨åŒæ¨¡å¼
            - âœ… è‡ªåŠ¨ç« èŠ‚è¯†åˆ«
            - âœ… ä¹¦ç­¾å’Œæ ‡æ³¨
            - âœ… å…¨æ–‡æœç´¢
            - âœ… TTS æœ—è¯»
            - âœ… iPad åˆ†å±æ”¯æŒ
            - âœ… é”®ç›˜å¿«æ·é”®
            
            æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          files: build/TxtReader-unsigned.ipa
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

