# 性能优化说明

## 已实施的性能优化

### 1. 异步加载优化
- ✅ 文本解码在后台线程执行
- ✅ 章节识别在后台线程执行
- ✅ 分页计算在后台线程执行
- ✅ 搜索在后台线程执行

### 2. 渲染优化

#### 分页模式
- 懒加载相邻页面（只在滑动时加载）
- 使用 `zIndex` 优化层级
- 限制最大分页数为 1000 页
- 预分配数组容量减少内存重新分配

#### 滚动模式
- 使用 `LazyVStack` 按需渲染
- 按段落分割文本
- 虚拟化长列表

### 3. 搜索优化
- 限制最大结果数为 200
- 使用 `.userInitiated` 优先级
- 在后台线程执行搜索

### 4. 章节识别优化
- 只检查前 10000 行（大多数章节在前面）
- 避免对超长文本全文扫描

### 5. 动画优化
- 翻页动画从 `.spring()` 改为 `.easeOut(duration: 0.25)`
- 添加速度阈值快速翻页
- 限制拖动范围

### 6. 网络优化
- 减少超时时间到 15 秒
- 不等待连接性（快速失败）
- 合理的 URLSession 配置

## 性能指标

### 预期表现

| 操作 | 预期时间 |
|------|---------|
| 打开小文件 (< 1MB) | < 1秒 |
| 打开中等文件 (1-5MB) | 1-3秒 |
| 打开大文件 (5-10MB) | 3-5秒 |
| 分页计算 (1000页) | 2-4秒 |
| 章节识别 | < 1秒 |
| 搜索 (10000行) | 1-2秒 |
| 翻页动画 | 250ms |

### 内存使用

- **小文件** (< 1MB): 约 50MB
- **中等文件** (1-5MB): 约 100-200MB
- **大文件** (5-10MB): 约 200-400MB

## 已知限制

1. **分页模式最大页数**: 1000 页
   - 对于超大文件，建议使用滚动模式

2. **搜索结果上限**: 200 条
   - 避免内存占用过大

3. **章节识别范围**: 前 10000 行
   - 足以覆盖大多数书籍的章节

## 进一步优化建议

### 如果仍然卡顿

1. **减少分页精度**
   - 增大每页字符数
   - 减少字体大小计算复杂度

2. **延迟加载章节**
   - 首次只加载前几章
   - 滚动时动态加载

3. **缓存优化**
   - 缓存已计算的分页结果
   - 缓存章节识别结果

4. **渲染优化**
   - 使用更简单的字体
   - 减少行距和段落间距
   - 禁用不必要的动画

## 性能测试

### 建议的测试文件大小
- 小文件: 100KB - 1MB
- 中等文件: 1MB - 5MB
- 大文件: 5MB - 10MB
- 超大文件: > 10MB（使用滚动模式）

### 测试设备
- iPad Pro 11" (2021) 或更新
- iPad (第 8 代) 或更新
- 建议使用 iOS 17+ 以获得最佳性能

## 性能监控

如果需要监控性能：
- 使用 Xcode Instruments 中的 Time Profiler
- 监控内存使用（Memory Graph）
- 检查主线程卡顿（Main Thread Checker）

## 用户建议

对于超大文件（> 10MB）：
1. 使用**滚动模式**而不是分页模式
2. 考虑将文件分割为多个小文件
3. 或使用更高性能的 iPad 设备

